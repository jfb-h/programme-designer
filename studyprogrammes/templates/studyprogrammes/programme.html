{% extends "studyprogrammes/layout.html" %}
{% load dict_extras %}
{% block content %}
<style>
.course-block[data-group="PG"] { background: #e3f2fd; }
.course-block[data-group="HG"] { background: #e8f5e9; }
.course-block[data-group="MU"] { background: #fff3e0; }
.semester-ects {
  color: #aaa;
  font-style: italic;
  font-size: 1em;
  margin-left: 1em;
}
.programme-prefix {
  color: #b2b1b1;
  font-weight: bold;
  font-size: 1.0em;
}
#edit-programme-form {
  font-size: 0.7em;
  display: none;
  margin: 0;
  padding: 0;
  align-items: center;
  gap: 0.5em;
}
#edit-programme-form.show {
  display: inline-flex;
}
</style>

<!-- Programme Title with Prefix and Edit Button -->
<h1 style="display: flex; align-items: center; gap:0.3em;">
  <span class="programme-prefix">
    {% if programme.degree_type == 'bachelor' %}
      BA 
    {% elif programme.degree_type == 'master' %}
      MA 
    {% elif programme.degree_type == 'teaching' %}
      LA 
    {% endif %}

  </span>
  <span id="programme-name-display">{{ programme.name }}</span>
  <button 
    style="border:none; background-color:#fff"
    type="button" onclick="document.getElementById('edit-programme-form').style.display='inline'; this.style.display='none'; document.getElementById('programme-name-display').style.display='none';" >
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.7" stroke="currentColor" width="20" height="20">
      <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
    </svg>
  </button>
  <form id="edit-programme-form" method="post">
    {% csrf_token %}
    <input 
      type="text" 
      name="programme_name" 
      value="{{ programme.name }}" 
      style="font-size:0.98em; padding:0.15em 0.5em; border:1px solid #bbb; border-radius:5px; background:#fafafa; min-width:120px;"
    >
    <button 
      type="submit" 
      name="edit_programme" 
      style="font-size:0.95em; padding:0.15em 0.9em; border-radius:5px; border:1px solid #bbb; background:#e0e0e0; cursor:pointer; margin-left:0.2em;"
    >Save</button>
  </form>
</h1>

<!-- Programme stats -->
<div style="display:flex; gap:1em; margin-bottom:1.2em;">
  <span style="background:#888; color:#fff; border-radius:12px; padding:0.3em 1.2em; font-weight:bold; font-size:1.1em; display:inline-block;">
    Total ECTS: {{ total_ects|default:0|floatformat:0 }}
  </span>
  <span style="background:#888; color:#fff; border-radius:12px; padding:0.3em 1.2em; font-weight:bold; font-size:1.1em; display:inline-block;">
    Total SWS: {{ total_sws_min|floatformat:1 }} - {{ total_sws_max|floatformat:1 }}
  </span>
</div>

<hr/>

<!-- Semester List -->
<div id="semester-list">
{% for semester in semesters %}
  <div class="semester-block" id="semester-{{ semester.id }}" style="margin-bottom:2em;">
    <div style="display:flex; align-items:center; gap:1em; margin-bottom:0.5em">
      <span class="semester-handle" style="cursor:grab;">&#9776;</span>
      <h2>
        {{ semester.number }}. Semester
      </h2>
      <!-- Remove Semester Button -->
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="delete_semester_id" value="{{ semester.id }}">
        <button type="submit" name="delete_semester"
          style="background:none; color:#e74c3c; border:none; border-radius:2px; padding:0.0em 0.0em; cursor:pointer; font-size:1.3em;"
          title="Remove Semester">&times;</button>
      </form>
      <span class="semester-ects">
      </span>
    </div>
    <div style="font-size:0.95em; color:#888; margin-bottom:0.5em; display:flex; gap:0.7em; flex-wrap:wrap;">
      <span style="background:#888; color:#fff; border-radius:12px; padding:0.2em 0.9em; font-weight:bold; font-size:1em; display:inline-block;">{{ semester.ects_sum|default:0 }} ECTS allocated</span>
      <span style="background:#888; color:#fff; border-radius:12px; padding:0.2em 0.9em; font-weight:bold; font-size:1em; display:inline-block;">Students: {{ semester.expected_students.min }} - {{ semester.expected_students.max }}</span>
      <span style="background:#888; color:#fff; border-radius:12px; padding:0.2em 0.9em; font-weight:bold; font-size:1em; display:inline-block;">SWS: {{ semester.expected_sws_min|floatformat:1 }} - {{ semester.expected_sws_max|floatformat:1 }}</span>
    </div>
    <!-- Course Groups -->
    {% for group in course_type_groups %}
      {% with group_courses=semester.courses_by_type|dict_get:group.0 %}
        {% if group_courses %}
          <div class="course-group-row" style="margin-bottom:0.5em;">
            <div style="font-style:italic; margin-bottom:0.2em;">{{ group.1 }}</div>
            <div id="course-list-{{ semester.id }}-{{ group.0 }}" class="course-list" style="display:flex; gap:1em; flex-wrap:wrap;">
              {% for course in group_courses %}
                <div class="course-block" id="course-{{ course.id }}" data-group="{{ course.group }}" style="border:1px solid #ccc; border-radius:8px; padding:1em; width:120px; position:relative;">
                  <form method="post" style="position:absolute; top:6px; right:6px; margin:0;">
                    {% csrf_token %}
                    <input type="hidden" name="delete_course_id" value="{{ course.id }}">
                    <button type="submit" name="delete_course"
                      style="background:none; color:#ccc; border:none; border-radius:50%; width:1.5em; height:1.5em; font-size:1em; line-height:1.2em; cursor:pointer; padding:0;"
                      title="Remove Course">&times;</button>
                  </form>
                  <span style="color:#b2b1b1; font-weight:bold; font-size:0.95em;">
                    {% if course.type == 'lecture' %}VL{% elif course.type == 'seminar' %}S{% elif course.type == 'tutorial' %}Ãœ{% elif course.type == 'fieldtrip' %}E{% elif course.type == 'thesis' %}T{% elif course.type == 'external' %}E{% endif %}
                  </span>
                  <strong>{{ course.name }}</strong><br>
                  {{ course.ects }} ECTS, {{ course.sws }} SWS <br>
                  {% if course.min_classes and course.max_classes %}
                    <span style="font-size:0.95em; color:#888;">
                      {% if course.min_classes == course.max_classes %}
                        {{ course.min_classes }} class{% if course.min_classes > 1 %}es{% endif %}
                      {% else %}
                        {{ course.min_classes }}-{{ course.max_classes }} classes
                      {% endif %}
                    </span><br>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      {% endwith %}
    {% endfor %}

    <div style="margin-top:1em; display:flex; gap:1em; flex-wrap:wrap;">
        <div style="display:flex; align-items:center; justify-content:center; font-size:1em; padding:0.6em 0.0em; border:none">
        <svg width="24" height="24" fill="none" stroke="#2c3e50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:0.3em;"><circle cx="12" cy="12" r="11" stroke="#2c3e50" stroke-width="2"/><line x1="12" y1="7" x2="12" y2="17"/><line x1="7" y1="12" x2="17" y2="12"/></svg>
      </div>
      <button onclick="openModal('{{ semester.id }}', 'lecture')" style="display:flex; align-items:center; gap:0.5em; font-size:1em; padding:0.6em 1.2em; border:none; background:#f7f7f7; border-radius:6px; cursor:pointer;">
        Lecture
      </button>
      <button onclick="openModal('{{ semester.id }}', 'seminar')" style="display:flex; align-items:center; gap:0.5em; font-size:1em; padding:0.6em 1.2em; border:none; background:#f7f7f7; border-radius:6px; cursor:pointer;">
        Seminar
      </button>
      <button onclick="openModal('{{ semester.id }}', 'tutorial')" style="display:flex; align-items:center; gap:0.5em; font-size:1em; padding:0.6em 1.2em; border:none; background:#f7f7f7; border-radius:6px; cursor:pointer;">
        Tutorial
      </button>
      <button onclick="openModal('{{ semester.id }}', 'fieldtrip')" style="display:flex; align-items:center; justify-content:center; font-size:1em; padding:0.6em 1.2em; border:none; background:#f7f7f7; border-radius:6px; cursor:pointer;">
        <!-- <svg width="800px" height="800px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path fill="#000000" d="M155.605 114.634l-14.31 7.154 3.576 7.156 13.423 26.844-57.578 57.578h22.625l42.494-42.494 21.248 42.494h17.89l-45.788-91.578-3.58-7.154zm132.422 2.732v24c0 11.313 5.527 24.452 12.13 39.47 6.345 14.432 13.97 29.757 19.87 42.33v54.2h-93.765l-16-48H80.027v80h2.623c5.445-11.528 14.993-20.257 26.176-26.092 12.89-6.725 28.058-9.908 43.2-9.908 15.144 0 30.31 3.183 43.203 9.908 11.18 5.835 20.73 14.564 26.174 26.092h117.344c10.22-23.39 31.87-35.904 54.555-37.967 23.296-2.118 47.98 5.742 65.738 21.966h7.222l10.666-32h-28.9v-48H333.09c-5.778-12.2-12.63-26.108-18.285-38.97-6.367-14.482-10.778-28.342-10.778-33.03v-24h-16zm-256.054 72v80h32v-80h-32zm432.054 23.88v32h16v-32h-16zm-231.568 32.12l5.333 16h50.234v-16H232.46zm-184.433 40v24.303h16v-24.304h-16zm104 16a48 48 0 0 0-48 48 48 48 0 0 0 48 48 48 48 0 0 0 48-48 48 48 0 0 0-48-48zm253.557 0a48 48 0 0 0-48 48 48 48 0 0 0 48 48 48 48 0 0 0 48-48 48 48 0 0 0-48-48zm-173.557 24v16h96v-16h-96zm-80 8a16 16 0 0 1 16 16 16 16 0 0 1-16 16 16 16 0 0 1-16-16 16 16 0 0 1 16-16zm253.557 0a16 16 0 0 1 16 16 16 16 0 0 1-16 16 16 16 0 0 1-16-16 16 16 0 0 1 16-16z"/></svg> -->
        Field Trip
      </button>
      <button onclick="openModal('{{ semester.id }}', 'thesis')" title="Add Thesis" style="display:flex; align-items:center; justify-content:center; font-size:1em; padding:0.6em 1.2em; border:none; background:#f7f7f7; border-radius:6px; cursor:pointer;">
        <!-- <svg width="24" height="24" fill="none" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.62 48.62 0 0 1 12 20.904a48.62 48.62 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.636 50.636 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.717 50.717 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" />
        </svg> -->
        Thesis
      </button>
      <button onclick="openModal('{{ semester.id }}', 'external')" style="display:flex; align-items:center; gap:0.5em; font-size:1em; padding:0.6em 1.2em; border:none; background:#f7f7f7; border-radius:6px; cursor:pointer;">
        External
      </button>
    </div>
  </div>
{% endfor %}
</div>

<!-- Modal Form -->
<div id="modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); align-items:center; justify-content:center;">
  <div style="background:#fff; padding:2em; border-radius:8px; min-width:320px; position:relative;">
    <button onclick="closeModal()" style="position:absolute; top:8px; right:8px;">&times;</button>
    <h3>Add Course</h3>
    <form method="post" id="courseForm">
      {% csrf_token %}
      <div style="margin-bottom:1em; border-bottom:1px solid #eee; padding-bottom:1em;">
        {{ course_form.name.label_tag }} {{ course_form.name }}<br>
        <div class="radio-row">
          {{ course_form.group }}
        </div>
      </div>
      <div>
        {{ course_form.type.label_tag }} {{ course_form.type }}<br>
        {{ course_form.ects.label_tag }} {{ course_form.ects }}<br>
        {{ course_form.sws.label_tag }} {{ course_form.sws }}<br>
        {{ course_form.max_participants.label_tag }} {{ course_form.max_participants }}
      </div>
      {{ course_form.semester.as_hidden }}
      <input type="hidden" name="semester" id="semesterInput">
      <input type="hidden" name="type" id="typeInput">
      <button type="submit" name="add_course" style="margin-top:1em;">Add</button>
    </form>
  </div>
</div>

<!-- Add Semester Form Row -->
<div>
  <form method="post" style="display:flex; align-items:flex-end; gap:1em;">
    {% csrf_token %}
    {{ semester_form.name.label_tag }} {{ semester_form.name }}
    {{ semester_form.programme.as_hidden }}
    <button type="submit" name="add_semester" style="height:2.4em;">Add Semester</button>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var el = document.getElementById('semester-list');
  if (el) {
    Sortable.create(el, {
      animation: 150,
      handle: '.semester-handle',
      draggable: '.semester-block',
      onEnd: function (evt) {
        // Collect the new order of semester IDs
        const order = Array.from(el.children).map(child => child.id.replace('semester-', ''));
        fetch(`{{ request.path }}update_semester_order/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
          },
          body: JSON.stringify({ order: order })
        });
      }
    });
  }

  // Course reordering for each semester
  document.querySelectorAll('.course-list').forEach(function(courseList) {
    Sortable.create(courseList, {
      animation: 150,
      handle: '.course-block', // allow dragging by the whole course card
      draggable: '.course-block',
      onEnd: function(evt) {
        // Extract only the semester id from the course-list id
        const match = courseList.id.match(/^course-list-(\d+)-/);
        const semesterId = match ? match[1] : null;
        const order = Array.from(courseList.children).map(child => child.id.replace('course-', ''));
        if (semesterId) {
          fetch(`{{ request.path }}update_course_order/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ semester: semesterId, order: order })
          });
        }
      }
    });
  });
});
</script>

<script>
const typeDefaults = {
  seminar: {ects: 3, sws: 2, max_participants: 30},
  lecture: {ects: 3, sws: 2, max_participants: 600},
  tutorial: {ects: 3, sws: 2, max_participants: 30},
  fieldtrip: {ects: 9, sws: 1, max_participants: 20},
  thesis: {ects: 12, sws: 0, max_participants: 1},
  external: {ects: 6, sws: 0, max_participants: 1},
};

function openModal(semesterId, courseType) {
  document.getElementById('modal').style.display = 'flex';
  document.getElementById('semesterInput').value = semesterId;
  if (courseType) {
    document.getElementById('typeInput').value = courseType;
    // Set the select field for type, if present
    const typeField = document.getElementById('id_type');
    if (typeField) typeField.value = courseType;
    setCourseDefaults(courseType);
  }
}

function setCourseDefaults(type) {
  const defaults = typeDefaults[type];
  if (defaults) {
    document.getElementById('id_ects').value = defaults.ects;
    document.getElementById('id_sws').value = defaults.sws;
    document.getElementById('id_max_participants').value = defaults.max_participants;
  }
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
}
</script>

{% endblock %}